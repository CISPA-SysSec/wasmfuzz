From b7d34dd927f607cc88d615060e1b44853e68c9fd Mon Sep 17 00:00:00 2001
Date: Sun, 17 Dec 2023 01:31:28 +0100
Subject: [PATCH 1/2] add fuzzer

---
 fuzz/.gitignore                |  4 ++
 fuzz/Cargo.lock                | 98 ++++++++++++++++++++++++++++++++++
 fuzz/Cargo.toml                | 27 ++++++++++
 fuzz/fuzz_targets/parse_ogg.rs | 16 ++++++
 4 files changed, 145 insertions(+)
 create mode 100644 fuzz/.gitignore
 create mode 100644 fuzz/Cargo.lock
 create mode 100644 fuzz/Cargo.toml
 create mode 100644 fuzz/fuzz_targets/parse_ogg.rs

diff --git a/fuzz/.gitignore b/fuzz/.gitignore
new file mode 100644
index 0000000..1a45eee
--- /dev/null
+++ b/fuzz/.gitignore
@@ -0,0 +1,4 @@
+target
+corpus
+artifacts
+coverage
diff --git a/fuzz/Cargo.lock b/fuzz/Cargo.lock
new file mode 100644
index 0000000..842341a
--- /dev/null
+++ b/fuzz/Cargo.lock
@@ -0,0 +1,98 @@
+# This file is automatically @generated by Cargo.
+# It is not intended for manual editing.
+version = 3
+
+[[package]]
+name = "arbitrary"
+version = "1.3.2"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "7d5a26814d8dcb93b0e5a0ff3c6d80a8843bafb21b39e8e18a6f05471870e110"
+
+[[package]]
+name = "byteorder"
+version = "1.5.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "1fd0f2584146f6f2ef48085050886acf353beff7305ebd1ae69500e27c67f64b"
+
+[[package]]
+name = "cc"
+version = "1.0.83"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "f1174fb0b6ec23863f8b971027804a42614e347eafb0a95bf0b12cdae21fc4d0"
+dependencies = [
+ "jobserver",
+ "libc",
+]
+
+[[package]]
+name = "jobserver"
+version = "0.1.27"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "8c37f63953c4c63420ed5fd3d6d398c719489b9f872b9fa683262f8edd363c7d"
+dependencies = [
+ "libc",
+]
+
+[[package]]
+name = "lewton"
+version = "0.10.2"
+dependencies = [
+ "byteorder",
+ "ogg",
+ "tinyvec",
+]
+
+[[package]]
+name = "lewton-fuzz"
+version = "0.0.0"
+dependencies = [
+ "lewton",
+ "libfuzzer-sys",
+]
+
+[[package]]
+name = "libc"
+version = "0.2.151"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "302d7ab3130588088d277783b1e2d2e10c9e9e4a16dd9050e6ec93fb3e7048f4"
+
+[[package]]
+name = "libfuzzer-sys"
+version = "0.4.7"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "a96cfd5557eb82f2b83fed4955246c988d331975a002961b07c81584d107e7f7"
+dependencies = [
+ "arbitrary",
+ "cc",
+ "once_cell",
+]
+
+[[package]]
+name = "ogg"
+version = "0.8.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "6951b4e8bf21c8193da321bcce9c9dd2e13c858fe078bf9054a288b419ae5d6e"
+dependencies = [
+ "byteorder",
+]
+
+[[package]]
+name = "once_cell"
+version = "1.19.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "3fdb12b2476b595f9358c5161aa467c2438859caa136dec86c26fdd2efe17b92"
+
+[[package]]
+name = "tinyvec"
+version = "1.6.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "87cc5ceb3875bb20c2890005a4e226a4651264a5c75edb2421b52861a0a0cb50"
+dependencies = [
+ "tinyvec_macros",
+]
+
+[[package]]
+name = "tinyvec_macros"
+version = "0.1.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "1f3ccbac311fea05f86f61904b462b55fb3df8837a366dfc601a0161d0532f20"
diff --git a/fuzz/Cargo.toml b/fuzz/Cargo.toml
new file mode 100644
index 0000000..ab5edb9
--- /dev/null
+++ b/fuzz/Cargo.toml
@@ -0,0 +1,27 @@
+[package]
+name = "lewton-fuzz"
+version = "0.0.0"
+publish = false
+edition = "2015"
+
+[package.metadata]
+cargo-fuzz = true
+
+[dependencies]
+libfuzzer-sys = "0.4"
+
+[dependencies.lewton]
+path = ".."
+
+# Prevent this from interfering with workspaces
+[workspace]
+members = ["."]
+
+[profile.release]
+debug = 1
+
+[[bin]]
+name = "parse_ogg"
+path = "fuzz_targets/parse_ogg.rs"
+test = false
+doc = false
diff --git a/fuzz/fuzz_targets/parse_ogg.rs b/fuzz/fuzz_targets/parse_ogg.rs
new file mode 100644
index 0000000..f4b6a6b
--- /dev/null
+++ b/fuzz/fuzz_targets/parse_ogg.rs
@@ -0,0 +1,16 @@
+#![no_main]
+
+extern crate libfuzzer_sys;
+extern crate lewton;
+
+use libfuzzer_sys::fuzz_target;
+
+use std::io::Cursor;
+
+fuzz_target!(|data: &[u8]| {
+    // fuzzed code goes here
+	let cursor = Cursor::new(data);
+	if let Ok(mut reader) = lewton::inside_ogg::OggStreamReader::new(cursor) {
+		while let Ok(Some(_)) = reader.read_dec_packet() {}
+	}
+});
-- 
2.46.0

